generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                       Int                         @id @default(autoincrement())
  username                 String                      @unique
  password                 String
  firstName                String?
  lastName                 String?
  birthday                 DateTime?
  bankDetails              String?
  contract                 String?
  salary                   Float?
  createdAt                DateTime                    @default(now())
  updatedAt                DateTime                    @updatedAt
  email                    String                      @unique
  country                  String                      @default("CO")
  hourlyRate               Decimal?
  language                 String                      @default("es")
  normalWorkingHours       Float                       @default(7.6)
  payrollCountry           String                      @default("CH")
  approvedOvertimeHours    Float                       @default(0)
  contractType             String?
  monthlySalary            Float?
  employeeNumber           String?
  identificationNumber     String?
  taxIdentificationNumber  String?
  gender                   String?                     // "male", "female", "other"
  active                   Boolean                     @default(true)
  carticlesCreated         CerebroCarticle[]           @relation("CarticleCreator")
  carticlesUpdated         CerebroCarticle[]           @relation("CarticleUpdater")
  externalLinks            CerebroExternalLink[]
  cerebroMedia             CerebroMedia[]
  consultationInvoices     ConsultationInvoice[]
  payrolls                 EmployeePayroll[]
  identificationDocuments  IdentificationDocument[]
  invoiceSettings          InvoiceSettings?
  monthlyReports           MonthlyConsultationReport[]
  notifications            Notification[]
  invitationsAccepted      OrganizationInvitation[]    @relation("InvitationAcceptor")
  invitationsSent          OrganizationInvitation[]    @relation("Inviter")
  joinRequestsProcessed    OrganizationJoinRequest[]   @relation("JoinProcessor")
  joinRequestsSent         OrganizationJoinRequest[]   @relation("JoinRequester")
  requestsRequester        Request[]                   @relation("requester")
  requestsResponsible      Request[]                   @relation("responsible")
  savedFilters             SavedFilter[]
  filterGroups             FilterGroup[]
  settings                 Settings?
  tasksQualityControl      Task[]                      @relation("quality_control")
  tasksResponsible         Task[]                      @relation("responsible")
  userNotificationSettings UserNotificationSettings?
  roles                    UserRole[]
  tableSettings            UserTableSettings[]
  branches                 UsersBranches[]
  workTimes                WorkTime[]
  taskStatusChanges        TaskStatusHistory[]         @relation("task_status_changes")
  employeeLifecycle        EmployeeLifecycle?
  lifecycleEventsTriggered LifecycleEvent[]            @relation("LifecycleEventTriggerer")
  certificatesGenerated    EmploymentCertificate[]     @relation("CertificateGenerator")
  contractsGenerated       EmploymentContract[]        @relation("ContractGenerator")
  passwordResetTokens      PasswordResetToken[]
}

model Organization {
  id                   Int                         @id @default(autoincrement())
  name                 String                      @unique
  displayName          String
  domain               String?                     @unique
  logo                 String?
  isActive             Boolean                     @default(true)
  maxUsers             Int                         @default(50)
  subscriptionPlan     String                      @default("basic")
  subscriptionEnd      DateTime?
  settings             Json?
  country              String?                     // Land der Organisation (z.B. "CO" für Kolumbien)
  nit                  String?                     // NIT (Número de Identificación Tributaria) für Kolumbien
  createdAt            DateTime                    @default(now())
  updatedAt            DateTime                    @updatedAt
  invitations          OrganizationInvitation[]
  joinRequests         OrganizationJoinRequest[]
  roles                Role[]
  tasks                Task[]
  requests             Request[]
  workTimes            WorkTime[]
  clients              Client[]
  branches             Branch[]
  consultationInvoices ConsultationInvoice[]
  monthlyReports       MonthlyConsultationReport[]
  carticles            CerebroCarticle[]
  employeeLifecycles   EmployeeLifecycle[]
  reservations         Reservation[]
}

model OrganizationJoinRequest {
  id             Int               @id @default(autoincrement())
  organizationId Int
  requesterId    Int
  status         JoinRequestStatus @default(pending)
  message        String?
  response       String?
  processedBy    Int?
  processedAt    DateTime?
  createdAt      DateTime          @default(now())
  updatedAt      DateTime          @updatedAt
  organization   Organization      @relation(fields: [organizationId], references: [id])
  processor      User?             @relation("JoinProcessor", fields: [processedBy], references: [id])
  requester      User              @relation("JoinRequester", fields: [requesterId], references: [id])

  @@unique([organizationId, requesterId])
}

model OrganizationInvitation {
  id             Int          @id @default(autoincrement())
  organizationId Int
  email          String
  roleId         Int
  invitedBy      Int
  token          String       @unique
  expiresAt      DateTime
  acceptedAt     DateTime?
  acceptedBy     Int?
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  acceptor       User?        @relation("InvitationAcceptor", fields: [acceptedBy], references: [id])
  inviter        User         @relation("Inviter", fields: [invitedBy], references: [id])
  organization   Organization @relation(fields: [organizationId], references: [id])
  role           Role         @relation(fields: [roleId], references: [id])
}

model Role {
  id             Int                      @id @default(autoincrement())
  name           String
  description    String?
  organizationId Int?
  invitations    OrganizationInvitation[]
  permissions    Permission[]
  organization   Organization?            @relation(fields: [organizationId], references: [id])
  tasks          Task[]
  users          UserRole[]

  @@unique([name, organizationId])
}

model UserRole {
  id        Int      @id @default(autoincrement())
  userId    Int
  roleId    Int
  lastUsed  Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  role      Role     @relation(fields: [roleId], references: [id])
  user      User     @relation(fields: [userId], references: [id])

  @@unique([userId, roleId])
}

model Permission {
  id          Int      @id @default(autoincrement())
  roleId      Int
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  accessLevel String
  entity      String
  entityType  String   @default("page")
  role        Role     @relation(fields: [roleId], references: [id])
}

model Branch {
  id                Int                 @id @default(autoincrement())
  name              String              @unique
  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @updatedAt
  organizationId    Int?
  organization      Organization?       @relation(fields: [organizationId], references: [id])
  requests          Request[]
  tasks             Task[]
  users             UsersBranches[]
  workTimes         WorkTime[]
  taskStatusChanges TaskStatusHistory[]
}

model UsersBranches {
  id        Int      @id @default(autoincrement())
  userId    Int
  branchId  Int
  lastUsed  Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  branch    Branch   @relation(fields: [branchId], references: [id])
  user      User     @relation(fields: [userId], references: [id])

  @@unique([userId, branchId])
}

model WorkTime {
  id              Int                        @id @default(autoincrement())
  userId          Int
  branchId        Int
  startTime       DateTime
  endTime         DateTime?
  createdAt       DateTime                   @default(now())
  updatedAt       DateTime                   @updatedAt
  timezone        String?
  clientId        Int?
  notes           String?
  monthlyReportId Int?
  organizationId  Int?
  organization    Organization?              @relation(fields: [organizationId], references: [id])
  invoiceItems    ConsultationInvoiceItem[]
  branch          Branch                     @relation(fields: [branchId], references: [id])
  client          Client?                    @relation(fields: [clientId], references: [id])
  monthlyReport   MonthlyConsultationReport? @relation(fields: [monthlyReportId], references: [id])
  user            User                       @relation(fields: [userId], references: [id])
  taskLinks       WorkTimeTask[]
}

model Task {
  id               Int                   @id @default(autoincrement())
  title            String
  description      String?
  status           TaskStatus            @default(open)
  responsibleId    Int?
  qualityControlId Int
  branchId         Int
  dueDate          DateTime?
  createdAt        DateTime              @default(now())
  updatedAt        DateTime              @updatedAt
  roleId           Int?
  organizationId   Int?
  organization     Organization?         @relation(fields: [organizationId], references: [id])
  branch           Branch                @relation(fields: [branchId], references: [id])
  qualityControl   User                  @relation("quality_control", fields: [qualityControlId], references: [id])
  responsible      User?                 @relation("responsible", fields: [responsibleId], references: [id])
  role             Role?                 @relation(fields: [roleId], references: [id])
  attachments      TaskAttachment[]
  carticles        TaskCerebroCarticle[]
  workTimeLinks    WorkTimeTask[]
  statusHistory    TaskStatusHistory[]
  reservationId    Int?                  @unique
  reservation      Reservation?          @relation(fields: [reservationId], references: [id])

  @@index([reservationId])
}

model Request {
  id             Int                      @id @default(autoincrement())
  title          String
  description    String?
  status         RequestStatus            @default(approval)
  type           RequestType              @default(other)
  isPrivate      Boolean                  @default(false)
  requesterId    Int
  responsibleId  Int
  branchId       Int
  dueDate        DateTime?
  createTodo     Boolean                  @default(false)
  createdAt      DateTime                 @default(now())
  updatedAt      DateTime                 @updatedAt
  organizationId Int?
  organization   Organization?            @relation(fields: [organizationId], references: [id])
  branch         Branch                   @relation(fields: [branchId], references: [id])
  requester      User                     @relation("requester", fields: [requesterId], references: [id])
  responsible    User                     @relation("responsible", fields: [responsibleId], references: [id])
  attachments    RequestAttachment[]
  carticles      RequestCerebroCarticle[]
}

model Settings {
  id               Int      @id @default(autoincrement())
  userId           Int      @unique
  companyLogo      String?
  darkMode         Boolean  @default(false)
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  sidebarCollapsed Boolean  @default(false)
  user             User     @relation(fields: [userId], references: [id])
}

model UserTableSettings {
  id            Int      @id @default(autoincrement())
  userId        Int
  tableId       String
  columnOrder   String
  hiddenColumns String
  viewMode      String? // 'table' oder 'cards'
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  user          User     @relation(fields: [userId], references: [id])

  @@unique([userId, tableId])
}

model FilterGroup {
  id         Int      @id @default(autoincrement())
  userId     Int
  tableId    String
  name       String
  order      Int      @default(0)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  user       User     @relation(fields: [userId], references: [id])
  filters    SavedFilter[]

  @@unique([userId, tableId, name])
}

model SavedFilter {
  id         Int      @id @default(autoincrement())
  userId     Int
  tableId    String
  name       String
  conditions String
  operators  String
  groupId    Int?
  order      Int      @default(0)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  user       User     @relation(fields: [userId], references: [id])
  group      FilterGroup? @relation(fields: [groupId], references: [id])

  @@unique([userId, tableId, name])
}

model Notification {
  id                Int              @id @default(autoincrement())
  userId            Int
  title             String
  message           String
  type              NotificationType
  read              Boolean          @default(false)
  relatedEntityId   Int?
  relatedEntityType String?
  createdAt         DateTime         @default(now())
  updatedAt         DateTime         @updatedAt
  carticleId        Int?
  carticle          CerebroCarticle? @relation(fields: [carticleId], references: [id])
  user              User             @relation(fields: [userId], references: [id])
}

model NotificationSettings {
  id                  Int      @id @default(autoincrement())
  taskCreate          Boolean  @default(true)
  taskUpdate          Boolean  @default(true)
  taskDelete          Boolean  @default(true)
  taskStatusChange    Boolean  @default(true)
  requestCreate       Boolean  @default(true)
  requestUpdate       Boolean  @default(true)
  requestDelete       Boolean  @default(true)
  requestStatusChange Boolean  @default(true)
  userCreate          Boolean  @default(true)
  userUpdate          Boolean  @default(true)
  userDelete          Boolean  @default(true)
  roleCreate          Boolean  @default(true)
  roleUpdate          Boolean  @default(true)
  roleDelete          Boolean  @default(true)
  worktimeStart       Boolean  @default(true)
  worktimeStop        Boolean  @default(true)
  worktimeAutoStop    Boolean  @default(true)
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
  carticleCreate      Boolean  @default(true)
  carticleDelete      Boolean  @default(true)
  carticleLink        Boolean  @default(true)
  carticleMention     Boolean  @default(true)
  carticleUpdate      Boolean  @default(true)
  worktimeManagerStop Boolean  @default(true)
}

model UserNotificationSettings {
  id                             Int      @id @default(autoincrement())
  userId                         Int      @unique
  taskCreate                     Boolean?
  taskUpdate                     Boolean?
  taskDelete                     Boolean?
  taskStatusChange               Boolean?
  requestCreate                  Boolean?
  requestUpdate                  Boolean?
  requestDelete                  Boolean?
  requestStatusChange            Boolean?
  userCreate                     Boolean?
  userUpdate                     Boolean?
  userDelete                     Boolean?
  roleCreate                     Boolean?
  roleUpdate                     Boolean?
  roleDelete                     Boolean?
  worktimeStart                  Boolean?
  worktimeStop                   Boolean?
  worktimeAutoStop               Boolean? @default(true)
  createdAt                      DateTime @default(now())
  updatedAt                      DateTime @updatedAt
  carticleCreate                 Boolean?
  carticleDelete                 Boolean?
  carticleLink                   Boolean?
  carticleMention                Boolean?
  carticleUpdate                 Boolean?
  worktimeManagerStop            Boolean?
  joinRequestApproved            Boolean?
  joinRequestReceived            Boolean?
  joinRequestRejected            Boolean?
  organizationInvitationReceived Boolean?
  user                           User     @relation(fields: [userId], references: [id])
}

model EmployeePayroll {
  id                              Int      @id @default(autoincrement())
  userId                          Int
  periodStart                     DateTime
  periodEnd                       DateTime
  regularHours                    Float
  overtimeHours                   Float
  nightHours                      Float
  holidayHours                    Float
  hourlyRate                      Decimal
  grossPay                        Decimal
  socialSecurity                  Decimal
  taxes                           Decimal
  netPay                          Decimal
  createdAt                       DateTime @default(now())
  updatedAt                       DateTime @updatedAt
  currency                        String   @default("CHF")
  deductions                      Decimal  @default(0)
  overtimeNightHours              Float    @default(0)
  overtimeNightSundayHolidayHours Float    @default(0)
  overtimeSundayHolidayHours      Float    @default(0)
  sundayHolidayHours              Float    @default(0)
  user                            User     @relation(fields: [userId], references: [id])
}

model CerebroCarticle {
  id             Int                      @id @default(autoincrement())
  title          String
  content        String?
  slug           String                   @unique
  parentId       Int?
  createdById    Int
  updatedById    Int?
  isPublished    Boolean                  @default(false)
  createdAt      DateTime                 @default(now())
  updatedAt      DateTime                 @updatedAt
  position       Int?                     @default(999)
  githubPath     String?
  organizationId Int?
  organization   Organization?            @relation(fields: [organizationId], references: [id])
  createdBy      User                     @relation("CarticleCreator", fields: [createdById], references: [id])
  parent         CerebroCarticle?         @relation("Hierarchy", fields: [parentId], references: [id])
  children       CerebroCarticle[]        @relation("Hierarchy")
  updatedBy      User?                    @relation("CarticleUpdater", fields: [updatedById], references: [id])
  externalLinks  CerebroExternalLink[]
  media          CerebroMedia[]
  notifications  Notification[]
  requests       RequestCerebroCarticle[]
  tasks          TaskCerebroCarticle[]
  tags           CerebroTag[]             @relation("CerebroCarticleToCerebroTag")
}

model TaskCerebroCarticle {
  id         Int             @id @default(autoincrement())
  taskId     Int
  carticleId Int
  createdAt  DateTime        @default(now())
  updatedAt  DateTime        @updatedAt
  carticle   CerebroCarticle @relation(fields: [carticleId], references: [id])
  task       Task            @relation(fields: [taskId], references: [id])

  @@unique([taskId, carticleId])
}

model RequestCerebroCarticle {
  id         Int             @id @default(autoincrement())
  requestId  Int
  carticleId Int
  createdAt  DateTime        @default(now())
  updatedAt  DateTime        @updatedAt
  carticle   CerebroCarticle @relation(fields: [carticleId], references: [id])
  request    Request         @relation(fields: [requestId], references: [id])

  @@unique([requestId, carticleId])
}

model CerebroMedia {
  id          Int             @id @default(autoincrement())
  path        String
  filename    String
  mimetype    String
  size        Int
  carticleId  Int
  createdById Int
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt
  carticle    CerebroCarticle @relation(fields: [carticleId], references: [id])
  createdBy   User            @relation(fields: [createdById], references: [id])
}

model CerebroExternalLink {
  id          Int             @id @default(autoincrement())
  url         String
  title       String?
  type        String
  carticleId  Int
  createdById Int
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt
  carticle    CerebroCarticle @relation(fields: [carticleId], references: [id])
  createdBy   User            @relation(fields: [createdById], references: [id])
}

model CerebroTag {
  id        Int               @id @default(autoincrement())
  name      String            @unique
  createdAt DateTime          @default(now())
  updatedAt DateTime          @updatedAt
  carticles CerebroCarticle[] @relation("CerebroCarticleToCerebroTag")
}

model TaskAttachment {
  id         Int      @id @default(autoincrement())
  taskId     Int
  fileName   String
  fileType   String
  fileSize   Int
  filePath   String
  uploadedAt DateTime @default(now())
  task       Task     @relation(fields: [taskId], references: [id], onDelete: Cascade)
}

model RequestAttachment {
  id         Int      @id @default(autoincrement())
  requestId  Int
  fileName   String
  fileType   String
  fileSize   Int
  filePath   String
  uploadedAt DateTime @default(now())
  request    Request  @relation(fields: [requestId], references: [id], onDelete: Cascade)
}

model IdentificationDocument {
  id               Int       @id @default(autoincrement())
  userId           Int
  documentType     String
  documentNumber   String
  issueDate        DateTime?
  expiryDate       DateTime?
  issuingCountry   String
  issuingAuthority String?
  documentFile     String?
  isVerified       Boolean   @default(false)
  verificationDate DateTime?
  verifiedBy       Int?
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt
  user             User      @relation(fields: [userId], references: [id])

  @@unique([userId, documentType])
}

model Client {
  id                   Int                             @id @default(autoincrement())
  name                 String
  company              String?
  email                String?
  phone                String?
  address              String?
  notes                String?
  isActive             Boolean                         @default(true)
  createdAt            DateTime                        @default(now())
  updatedAt            DateTime                        @updatedAt
  organizationId       Int?
  organization         Organization?                   @relation(fields: [organizationId], references: [id])
  consultationInvoices ConsultationInvoice[]
  monthlyReportItems   MonthlyConsultationReportItem[]
  workTimes            WorkTime[]
}

model ConsultationInvoice {
  id             Int                       @id @default(autoincrement())
  invoiceNumber  String
  clientId       Int
  userId         Int
  issueDate      DateTime                  @default(now())
  dueDate        DateTime
  status         InvoiceStatus             @default(DRAFT)
  subtotal       Decimal                   @db.Decimal(10, 2)
  vatRate        Decimal?                  @db.Decimal(5, 2)
  vatAmount      Decimal?                  @db.Decimal(10, 2)
  total          Decimal                   @db.Decimal(10, 2)
  currency       String                    @default("CHF")
  paymentTerms   String                    @default("30 Tage netto")
  notes          String?
  pdfPath        String?
  qrReference    String?
  createdAt      DateTime                  @default(now())
  updatedAt      DateTime                  @updatedAt
  organizationId Int?
  organization   Organization?             @relation(fields: [organizationId], references: [id])
  client         Client                    @relation(fields: [clientId], references: [id])
  user           User                      @relation(fields: [userId], references: [id])
  items          ConsultationInvoiceItem[]
  payments       InvoicePayment[]
}

model ConsultationInvoiceItem {
  id          Int                 @id @default(autoincrement())
  invoiceId   Int
  workTimeId  Int
  description String
  quantity    Decimal             @db.Decimal(10, 2)
  unitPrice   Decimal             @db.Decimal(10, 2)
  amount      Decimal             @db.Decimal(10, 2)
  createdAt   DateTime            @default(now())
  invoice     ConsultationInvoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  workTime    WorkTime            @relation(fields: [workTimeId], references: [id])

  @@unique([invoiceId, workTimeId])
}

model InvoicePayment {
  id            Int                 @id @default(autoincrement())
  invoiceId     Int
  amount        Decimal             @db.Decimal(10, 2)
  paymentDate   DateTime
  paymentMethod String
  reference     String?
  notes         String?
  createdAt     DateTime            @default(now())
  invoice       ConsultationInvoice @relation(fields: [invoiceId], references: [id])
}

model InvoiceSettings {
  id                     Int      @id @default(autoincrement())
  userId                 Int      @unique
  companyName            String
  companyAddress         String
  companyZip             String
  companyCity            String
  companyCountry         String   @default("CH")
  companyPhone           String?
  companyEmail           String?
  companyWebsite         String?
  vatNumber              String?
  iban                   String
  bankName               String?
  defaultHourlyRate      Decimal  @db.Decimal(10, 2)
  defaultVatRate         Decimal? @db.Decimal(5, 2)
  invoicePrefix          String   @default("INV")
  nextInvoiceNumber      Int      @default(1)
  footerText             String?
  createdAt              DateTime @default(now())
  updatedAt              DateTime @updatedAt
  monthlyReportDay       Int      @default(25)
  monthlyReportEnabled   Boolean  @default(false)
  monthlyReportRecipient String?
  user                   User     @relation(fields: [userId], references: [id])
}

model MonthlyConsultationReport {
  id             Int                             @id @default(autoincrement())
  userId         Int
  reportNumber   String
  periodStart    DateTime
  periodEnd      DateTime
  recipient      String
  totalHours     Decimal                         @db.Decimal(10, 2)
  totalAmount    Decimal?                        @db.Decimal(10, 2)
  currency       String                          @default("CHF")
  pdfPath        String?
  status         MonthlyReportStatus             @default(GENERATED)
  generatedAt    DateTime                        @default(now())
  createdAt      DateTime                        @default(now())
  updatedAt      DateTime                        @updatedAt
  organizationId Int?
  organization   Organization?                   @relation(fields: [organizationId], references: [id])
  user           User                            @relation(fields: [userId], references: [id])
  items          MonthlyConsultationReportItem[]
  workTimes      WorkTime[]
}

model MonthlyConsultationReportItem {
  id                Int                       @id @default(autoincrement())
  reportId          Int
  clientId          Int
  clientName        String
  totalHours        Decimal                   @db.Decimal(10, 2)
  consultationCount Int
  createdAt         DateTime                  @default(now())
  client            Client                    @relation(fields: [clientId], references: [id])
  report            MonthlyConsultationReport @relation(fields: [reportId], references: [id], onDelete: Cascade)
}

model WorkTimeTask {
  id         Int      @id @default(autoincrement())
  workTimeId Int
  taskId     Int
  createdAt  DateTime @default(now())
  task       Task     @relation(fields: [taskId], references: [id])
  workTime   WorkTime @relation(fields: [workTimeId], references: [id])

  @@unique([workTimeId, taskId])
}

model TaskStatusHistory {
  id        Int         @id @default(autoincrement())
  taskId    Int
  userId    Int
  oldStatus TaskStatus?
  newStatus TaskStatus
  changedAt DateTime    @default(now())
  branchId  Int
  task      Task        @relation(fields: [taskId], references: [id], onDelete: Cascade)
  user      User        @relation("task_status_changes", fields: [userId], references: [id])
  branch    Branch      @relation(fields: [branchId], references: [id])

  @@index([taskId])
  @@index([userId])
  @@index([changedAt])
  @@index([branchId])
}

enum TaskStatus {
  open
  in_progress
  improval
  quality_control
  done
}

enum RequestStatus {
  approval
  approved
  to_improve
  denied
}

enum RequestType {
  vacation
  improvement_suggestion
  sick_leave
  employment_certificate
  other
}

enum AccessLevel {
  read
  write
  both
  none
}

enum NotificationType {
  task
  request
  user
  role
  worktime
  system
  cerebro
  worktime_manager_stop
  joinRequest
  joinApproved
  joinRejected
  organizationInvitation
}

enum InvoiceStatus {
  DRAFT
  SENT
  PAID
  OVERDUE
  CANCELLED
}

enum MonthlyReportStatus {
  GENERATED
  SENT
  ARCHIVED
}

enum JoinRequestStatus {
  pending
  approved
  rejected
  withdrawn
}

enum SubscriptionPlan {
  basic
  pro
  enterprise
  trial
}

enum ReservationStatus {
  confirmed
  checked_in
  checked_out
  cancelled
  no_show
}

enum PaymentStatus {
  pending
  paid
  partially_paid
  refunded
}

// ============================================
// EMPLOYEE LIFECYCLE MODELS
// ============================================

enum EmployeeStatus {
  onboarding // User wurde hinzugefügt, Onboarding läuft
  active // User ist aktiv beschäftigt
  contract_change // Vertragsänderung läuft
  offboarding // Austritt läuft
  archived // User ist ausgetreten, Daten archiviert
}

enum SocialSecurityStatus {
  not_required // Nicht erforderlich (z.B. EPS bei bestehender Versicherung)
  pending // Anmeldung läuft
  registered // Erfolgreich registriert
  failed // Anmeldung fehlgeschlagen
  deregistered // Abgemeldet
}

model EmployeeLifecycle {
  id             Int            @id @default(autoincrement())
  userId         Int            @unique
  user           User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  organizationId Int
  organization   Organization   @relation(fields: [organizationId], references: [id])
  status         EmployeeStatus @default(onboarding)

  // Onboarding-Daten
  onboardingStartedAt   DateTime?
  onboardingCompletedAt DateTime?

  // Vertragsdaten
  contractStartDate DateTime?
  contractEndDate   DateTime?
  contractType      String? // "indefinite", "fixed_term", "temporary", etc.

  // Sozialversicherungen (Kolumbien)
  arlStatus       SocialSecurityStatus @default(pending)
  arlRegisteredAt DateTime?
  arlNumber       String?
  arlProvider     String? // Name der ARL-Versicherung

  epsStatus       SocialSecurityStatus @default(not_required)
  epsRequired     Boolean              @default(false)
  epsRegisteredAt DateTime?
  epsNumber       String?
  epsProvider     String?

  pensionStatus       SocialSecurityStatus @default(pending)
  pensionRegisteredAt DateTime?
  pensionNumber       String?
  pensionProvider     String?

  cajaStatus       SocialSecurityStatus @default(pending)
  cajaRegisteredAt DateTime?
  cajaNumber       String?
  cajaProvider     String?

  // Offboarding-Daten
  exitDate               DateTime?
  exitReason             String? // "resignation", "termination", "contract_end", etc.
  offboardingStartedAt   DateTime?
  offboardingCompletedAt DateTime?

  // Metadaten
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Beziehungen
  lifecycleEvents             LifecycleEvent[]
  employmentCertificates      EmploymentCertificate[]
  employmentContracts         EmploymentContract[]
  socialSecurityRegistrations SocialSecurityRegistration[]

  @@index([organizationId])
  @@index([status])
}

model LifecycleEvent {
  id              Int               @id @default(autoincrement())
  lifecycleId     Int
  lifecycle       EmployeeLifecycle @relation(fields: [lifecycleId], references: [id], onDelete: Cascade)
  eventType       String // "onboarding_started", "document_uploaded", "arl_registered", etc.
  eventData       Json? // Zusätzliche Event-Daten
  triggeredBy     Int? // User-ID, der das Event ausgelöst hat
  triggeredByUser User?             @relation("LifecycleEventTriggerer", fields: [triggeredBy], references: [id])
  createdAt       DateTime          @default(now())

  @@index([lifecycleId])
  @@index([eventType])
}

model EmploymentCertificate {
  id              Int               @id @default(autoincrement())
  lifecycleId     Int
  lifecycle       EmployeeLifecycle @relation(fields: [lifecycleId], references: [id], onDelete: Cascade)
  certificateType String            @default("employment") // "employment", "salary", "work_experience", etc.
  issueDate       DateTime          @default(now())
  pdfPath         String
  templateUsed    String? // Name des verwendeten Templates
  templateVersion String? // Version des Templates (für Nachverfolgbarkeit)
  generatedBy     Int? // User-ID, der das Zertifikat generiert hat
  generatedByUser User?             @relation("CertificateGenerator", fields: [generatedBy], references: [id])
  isLatest        Boolean           @default(true) // Ist dies die neueste Version?
  createdAt       DateTime          @default(now())

  @@index([lifecycleId])
  @@index([isLatest])
}

model EmploymentContract {
  id              Int               @id @default(autoincrement())
  lifecycleId     Int
  lifecycle       EmployeeLifecycle @relation(fields: [lifecycleId], references: [id], onDelete: Cascade)
  contractType    String            @default("employment") // "employment", "amendment", "extension", etc.
  startDate       DateTime
  endDate         DateTime?
  salary          Float?
  workingHours    Float?
  position        String?
  pdfPath         String
  templateUsed    String?
  templateVersion String?
  generatedBy     Int?
  generatedByUser User?             @relation("ContractGenerator", fields: [generatedBy], references: [id])
  isLatest        Boolean           @default(true)
  createdAt       DateTime          @default(now())

  // Beziehungen
  contractDocuments ContractDocument[]

  @@index([lifecycleId])
  @@index([isLatest])
}

model ContractDocument {
  id            Int                @id @default(autoincrement())
  contractId    Int
  contract      EmploymentContract @relation(fields: [contractId], references: [id], onDelete: Cascade)
  documentType  String // "original", "amendment", "extension", etc.
  pdfPath       String
  effectiveDate DateTime?
  createdAt     DateTime           @default(now())

  @@index([contractId])
}

model SocialSecurityRegistration {
  id                 Int                  @id @default(autoincrement())
  lifecycleId        Int
  lifecycle          EmployeeLifecycle    @relation(fields: [lifecycleId], references: [id], onDelete: Cascade)
  registrationType   String // "arl", "eps", "pension", "caja"
  registrationNumber String?
  provider           String? // Name des Providers
  registrationDate   DateTime?
  status             SocialSecurityStatus @default(pending)
  notes              String?
  completedBy        Int? // User-ID, der die Anmeldung abgeschlossen hat
  completedAt        DateTime?
  createdAt          DateTime             @default(now())
  updatedAt          DateTime             @updatedAt

  @@unique([lifecycleId, registrationType])
  @@index([lifecycleId])
  @@index([registrationType])
}

model PasswordResetToken {
  id        Int      @id @default(autoincrement())
  userId    Int
  token     String   @unique
  expiresAt DateTime
  used      Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([token])
  @@index([userId])
  @@index([expiresAt])
}

// ============================================
// LOBBYPMS RESERVATION MODELS
// ============================================

model Reservation {
  id                       Int                      @id @default(autoincrement())
  lobbyReservationId       String?                  @unique // ID aus LobbyPMS
  guestName                String
  guestEmail               String?
  guestPhone               String?
  checkInDate              DateTime
  checkOutDate             DateTime
  arrivalTime              DateTime? // Geschätzte Ankunftszeit
  roomNumber               String?
  roomDescription          String?
  status                   ReservationStatus        @default(confirmed)
  paymentStatus            PaymentStatus            @default(pending)
  paymentLink              String? // Bold Payment Link
  doorPin                  String? // PIN für Türsystem
  doorAppName              String? // App-Name (z.B. "TTLock")
  ttlLockId                String? // TTLock Lock ID
  ttlLockPassword          String? // TTLock Passcode/Password
  onlineCheckInCompleted   Boolean                  @default(false)
  onlineCheckInCompletedAt DateTime?
  invitationSentAt         DateTime? // Wann wurde die Check-in-Einladung versendet
  sireRegistered           Boolean                  @default(false)
  sireRegistrationId       String? // ID der SIRE-Registrierung
  sireRegisteredAt         DateTime?
  sireRegistrationError    String? // Fehlermeldung bei fehlgeschlagener Registrierung
  guestNationality         String? // Nationalität des Gastes (für SIRE)
  guestPassportNumber      String? // Passnummer (für SIRE)
  guestBirthDate           DateTime? // Geburtsdatum (für SIRE)
  organizationId           Int
  organization             Organization             @relation(fields: [organizationId], references: [id])
  taskId                   Int? // Verknüpfter Task
  task                     Task?                    @relation
  createdAt                DateTime                 @default(now())
  updatedAt                DateTime                 @updatedAt
  syncHistory              ReservationSyncHistory[]

  @@index([organizationId])
  @@index([checkInDate])
  @@index([status])
  @@index([lobbyReservationId])
  @@index([paymentStatus])
}

model ReservationSyncHistory {
  id            Int         @id @default(autoincrement())
  reservationId Int
  reservation   Reservation @relation(fields: [reservationId], references: [id], onDelete: Cascade)
  syncType      String // 'created', 'updated', 'status_changed'
  syncData      Json? // Vollständige Daten zum Zeitpunkt der Synchronisation
  syncedAt      DateTime    @default(now())
  errorMessage  String?

  @@index([reservationId])
  @@index([syncedAt])
}
